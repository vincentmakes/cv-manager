<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV</title>
    <meta name="description" content="Professional CV">
    <meta name="robots" content="index, follow">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/shared/styles.css">
</head>
<body>
    <div class="container" role="main">
        <!-- ATS-friendly hidden text version -->
        <div id="ats-content" class="ats-only" aria-hidden="true"></div>
        
        <!-- Header -->
        <header class="header" itemscope itemtype="https://schema.org/Person">
            <div class="header-content">
                <div class="profile-image" id="profileImage">
                    <span id="profileInitials">CV</span>
                    <img id="profilePicture" src="/uploads/picture.jpeg" alt="" style="display:none;">
                </div>
                <div class="profile-info">
                    <h1 class="profile-name" id="profileName" itemprop="name">Loading...</h1>
                    <p class="profile-title" id="profileTitle" itemprop="jobTitle"></p>
                    <p class="profile-subtitle" id="profileSubtitle"></p>
                    <address class="contact-badges" id="contactBadges"></address>
                </div>
            </div>
        </header>

        <!-- About Section -->
        <section class="section" id="section-about">
            <div class="section-header">
                <h2 class="section-title">Professional Summary</h2>
            </div>
            <p class="about-text" id="aboutText" itemprop="description"></p>
        </section>

        <!-- Timeline Section -->
        <section class="section" id="section-timeline">
            <div class="section-header">
                <h2 class="section-title">Career Timeline</h2>
            </div>
            <div class="timeline-container">
                <div class="timeline-track"></div>
                <div class="timeline-items" id="timelineItems"></div>
            </div>
        </section>

        <!-- Experience Section -->
        <section class="section" id="section-experience">
            <div class="section-header">
                <h2 class="section-title">Work Experience</h2>
            </div>
            <div class="items-list" id="experienceList"></div>
        </section>

        <!-- Certifications Section -->
        <section class="section" id="section-certifications">
            <div class="section-header">
                <h2 class="section-title">Certifications</h2>
            </div>
            <div class="cert-grid" id="certGrid"></div>
        </section>

        <!-- Education Section -->
        <section class="section" id="section-education">
            <div class="section-header">
                <h2 class="section-title">Education</h2>
            </div>
            <div class="items-list" id="educationList"></div>
        </section>

        <!-- Skills Section -->
        <section class="section" id="section-skills">
            <div class="section-header">
                <h2 class="section-title">Skills & Expertise</h2>
            </div>
            <div class="skills-grid" id="skillsGrid"></div>
        </section>

        <!-- Projects Section -->
        <section class="section" id="section-projects">
            <div class="section-header">
                <h2 class="section-title">Featured Projects</h2>
            </div>
            <div class="projects-grid" id="projectsGrid"></div>
        </section>
    </div>

    <script src="/shared/scripts.js"></script>
    <script>
        // Public site initialization - read-only, no private data
        let sectionOrder = [];
        let customSectionsData = [];
        let layoutTypesData = [];
        let socialPlatformsData = [];
        
        document.addEventListener('DOMContentLoaded', async () => {
            await loadThemeColorPublic();
            sectionOrder = await loadSectionOrder();
            await loadSections();
            await loadProfile(false); // false = don't include email/phone
            await loadTimeline();
            await loadExperiencesReadOnly();
            await loadCertificationsReadOnly();
            await loadEducationReadOnly();
            await loadSkillsReadOnly();
            await loadProjectsReadOnly();
            await loadCustomSectionsPublic();
            renderSectionsInOrder();
            await generateATSContent();
        });
        
        // Load section order from API
        async function loadSectionOrder() {
            try {
                return await api('/api/sections/order');
            } catch (err) {
                console.error('Failed to load section order:', err);
                return [];
            }
        }
        
        // Load custom sections
        async function loadCustomSectionsPublic() {
            try {
                customSectionsData = await api('/api/custom-sections');
                layoutTypesData = await api('/api/layout-types');
                socialPlatformsData = await api('/api/social-platforms');
                
                const container = document.querySelector('.container');
                
                customSectionsData.forEach(section => {
                    const sectionHtml = renderCustomSectionPublic(section, layoutTypesData, socialPlatformsData);
                    container.insertAdjacentHTML('beforeend', sectionHtml);
                });
            } catch (err) {
                console.error('Failed to load custom sections:', err);
            }
        }
        
        // Render sections in correct order in DOM
        function renderSectionsInOrder() {
            if (!sectionOrder.length) return;
            
            const container = document.querySelector('.container');
            if (!container) return;
            
            const header = document.querySelector('.header');
            const atsContent = document.getElementById('ats-content');
            
            // Get all section elements (built-in)
            const sectionElements = {
                'about': document.getElementById('section-about'),
                'timeline': document.getElementById('section-timeline'),
                'experience': document.getElementById('section-experience'),
                'certifications': document.getElementById('section-certifications'),
                'education': document.getElementById('section-education'),
                'skills': document.getElementById('section-skills'),
                'projects': document.getElementById('section-projects')
            };
            
            // Add custom section elements
            customSectionsData.forEach(cs => {
                const el = document.getElementById(`section-${cs.section_key}`);
                if (el) {
                    sectionElements[cs.section_key] = el;
                }
            });
            
            // Reorder sections based on sectionOrder (only visible ones from API)
            let lastInserted = header || atsContent;
            sectionOrder.forEach(section => {
                const el = sectionElements[section.key];
                if (el && lastInserted) {
                    lastInserted.after(el);
                    lastInserted = el;
                }
            });
        }
        
        async function loadThemeColorPublic() {
            try {
                const result = await api('/api/settings/themeColor');
                if (result.value) {
                    applyColorToCSSPublic(result.value);
                }
            } catch (err) {
                // Ignore errors, use default theme
            }
        }
        
        function applyColorToCSSPublic(hex) {
            const root = document.documentElement;
            const hsl = hexToHSLPublic(hex);
            
            root.style.setProperty('--primary', hex);
            root.style.setProperty('--primary-dark', hslToHexPublic(hsl.h, hsl.s, Math.max(hsl.l - 15, 10)));
            root.style.setProperty('--primary-light', hslToHexPublic(hsl.h, Math.min(hsl.s + 10, 100), Math.min(hsl.l + 15, 80)));
            root.style.setProperty('--accent', hslToHexPublic((hsl.h + 15) % 360, hsl.s, hsl.l));
            root.style.setProperty('--dark', hslToHexPublic(hsl.h, hsl.s, 15));
            root.style.setProperty('--light', hslToHexPublic(hsl.h, 30, 90));
            root.style.setProperty('--very-light', hslToHexPublic(hsl.h, 20, 97));
        }
        
        function hexToHSLPublic(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            const r = parseInt(result[1], 16) / 255;
            const g = parseInt(result[2], 16) / 255;
            const b = parseInt(result[3], 16) / 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            if (max === min) { h = s = 0; }
            else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }
            return { h: Math.round(h * 360), s: Math.round(s * 100), l: Math.round(l * 100) };
        }
        
        function hslToHexPublic(h, s, l) {
            s /= 100; l /= 100;
            const a = s * Math.min(l, 1 - l);
            const f = n => {
                const k = (n + h / 30) % 12;
                const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
                return Math.round(255 * color).toString(16).padStart(2, '0');
            };
            return `#${f(0)}${f(8)}${f(4)}`;
        }
    </script>
</body>
</html>
