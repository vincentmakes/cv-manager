<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV</title>
    <meta name="description" content="Professional CV">
    <meta name="robots" content="index, follow">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/shared/styles.css">
</head>
<body>
    <!-- Print Button (hidden by default, enabled via admin settings) -->
    <button class="public-print-btn no-print" id="publicPrintBtn" onclick="window.print()" style="display: none;" title="Print / Save as PDF">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
    </button>
    
    <!-- Preview Banner (only shown for versioned dataset URLs) -->
    <div class="preview-banner no-print" id="previewBanner" style="display: none;">
        <div class="preview-banner-content">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
            <span class="preview-banner-text">Preview Mode — This is a saved version and not publicly accessible</span>
        </div>
        <a href="/" class="preview-banner-btn">
            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
            Back to Admin
        </a>
    </div>
    
    <div class="container" role="main">
        <!-- ATS-friendly hidden text version -->
        <div id="ats-content" class="ats-only" aria-hidden="true"></div>
        
        <!-- Header -->
        <header class="header" itemscope itemtype="https://schema.org/Person">
            <div class="header-content">
                <div class="profile-image" id="profileImage">
                    <span id="profileInitials">CV</span>
                    <img id="profilePicture" src="/uploads/picture.jpeg" alt="" style="display:none;">
                </div>
                <div class="profile-info">
                    <h1 class="profile-name" id="profileName" itemprop="name">Loading...</h1>
                    <p class="profile-title" id="profileTitle" itemprop="jobTitle"></p>
                    <p class="profile-subtitle" id="profileSubtitle"></p>
                    <address class="contact-badges" id="contactBadges"></address>
                </div>
            </div>
        </header>

        <!-- About Section -->
        <section class="section" id="section-about">
            <div class="section-header">
                <h2 class="section-title">Professional Summary</h2>
            </div>
            <p class="about-text" id="aboutText" itemprop="description"></p>
        </section>

        <!-- Timeline Section -->
        <section class="section" id="section-timeline">
            <div class="section-header">
                <h2 class="section-title">Career Timeline</h2>
            </div>
            <div class="timeline-container">
                <div class="timeline-track"></div>
                <div class="timeline-items" id="timelineItems"></div>
            </div>
        </section>

        <!-- Experience Section -->
        <section class="section" id="section-experience">
            <div class="section-header">
                <h2 class="section-title">Work Experience</h2>
            </div>
            <div class="items-list" id="experienceList"></div>
        </section>

        <!-- Certifications Section -->
        <section class="section" id="section-certifications">
            <div class="section-header">
                <h2 class="section-title">Certifications</h2>
            </div>
            <div class="cert-grid" id="certGrid"></div>
        </section>

        <!-- Education Section -->
        <section class="section" id="section-education">
            <div class="section-header">
                <h2 class="section-title">Education</h2>
            </div>
            <div class="items-list" id="educationList"></div>
        </section>

        <!-- Skills Section -->
        <section class="section" id="section-skills">
            <div class="section-header">
                <h2 class="section-title">Skills & Expertise</h2>
            </div>
            <div class="skills-grid" id="skillsGrid"></div>
        </section>

        <!-- Projects Section -->
        <section class="section" id="section-projects">
            <div class="section-header">
                <h2 class="section-title">Featured Projects</h2>
            </div>
            <div class="projects-grid" id="projectsGrid"></div>
        </section>
    </div>

    <script src="/shared/scripts.js"></script>
    <script>
        // Public site initialization - read-only, no private data
        let sectionOrder = [];
        let customSectionsData = [];
        let layoutTypesData = [];
        let socialPlatformsData = [];
        let datasetData = null; // Holds dataset data when previewing a saved dataset
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Check if we're previewing a saved dataset (admin mode only)
            if (window.DATASET_SLUG) {
                await loadDatasetPreview();
            } else {
                await loadLiveData();
            }
        });
        
        // Load live data from current CV (normal mode)
        async function loadLiveData() {
            await loadThemeColorPublic();
            await loadPublicPrintButton();
            await loadPaginationSettings();
            await loadPageSplitsSetting();
            await loadTrackingCode();
            sectionOrder = await loadSectionOrder();
            await loadSections();
            await loadProfile(false); // false = don't include email/phone
            await loadTimeline();
            await loadExperiencesReadOnly();
            await loadCertificationsReadOnly();
            await loadEducationReadOnly();
            await loadSkillsReadOnly();
            await loadProjectsReadOnly();
            await loadCustomSectionsPublic();
            renderSectionsInOrder();
            await generateATSContent();
        }
        
        // Load saved dataset preview (admin mode only)
        async function loadDatasetPreview() {
            try {
                datasetData = await api(`/api/datasets/slug/${window.DATASET_SLUG}`);
                if (!datasetData || datasetData.error) {
                    console.error('Failed to load dataset');
                    return;
                }
                
                // Show preview banner
                document.getElementById('previewBanner').style.display = 'flex';
                document.body.classList.add('has-preview-banner');
                
                await loadThemeColorPublic();
                await loadPublicPrintButton();
                await loadPaginationSettings();
                await loadPageSplitsSetting();
                
                // Load layout types and social platforms for custom sections
                layoutTypesData = await api('/api/layout-types');
                socialPlatformsData = await api('/api/social-platforms');
                
                // Render from dataset data
                renderProfileFromData(datasetData.profile);
                renderTimelineFromData(datasetData.experiences);
                renderExperiencesFromData(datasetData.experiences);
                renderCertificationsFromData(datasetData.certifications);
                renderEducationFromData(datasetData.education);
                renderSkillsFromData(datasetData.skills);
                renderProjectsFromData(datasetData.projects);
                
                // Handle section visibility from dataset
                if (datasetData.sectionVisibility) {
                    Object.keys(datasetData.sectionVisibility).forEach(section => {
                        const el = document.getElementById(`section-${section}`);
                        if (el) {
                            if (!datasetData.sectionVisibility[section]) {
                                el.classList.add('hidden-print');
                                el.style.display = 'none';
                            } else {
                                el.classList.remove('hidden-print');
                                el.style.display = '';
                            }
                        }
                    });
                }
                
                // Reorder sections if sectionOrder is in dataset
                if (datasetData.sectionOrder) {
                    sectionOrder = datasetData.sectionOrder.filter(s => s.visible !== false).map(s => ({ key: s.key, visible: s.visible }));
                    renderSectionsInOrder();
                }
                
            } catch (err) {
                console.error('Error loading dataset preview:', err);
            }
        }
        
        // Render functions for dataset data
        function renderProfileFromData(p) {
            if (!p) return;
            document.getElementById('profileInitials').textContent = p.initials || 'CV';
            document.getElementById('profileName').textContent = p.name || '';
            document.getElementById('profileTitle').textContent = p.title || '';
            document.getElementById('profileSubtitle').textContent = p.subtitle || '';
            document.getElementById('aboutText').textContent = p.bio || '';
            if (p.name) document.title = `${p.name} - CV`;
            
            const pic = document.getElementById('profilePicture');
            const initials = document.getElementById('profileInitials');
            pic.onload = () => { pic.style.display = 'block'; initials.style.display = 'none'; };
            pic.onerror = () => { pic.style.display = 'none'; initials.style.display = 'block'; };
            pic.src = '/uploads/picture.jpeg?' + new Date().getTime();
            
            const badges = [];
            if (p.location) badges.push(`<span class="contact-badge" itemprop="address">${icons.location} ${escapeHtml(p.location)}</span>`);
            if (p.linkedin) badges.push(`<a href="${escapeHtml(p.linkedin)}" class="contact-badge" target="_blank" rel="noopener" itemprop="url">${icons.linkedin} LinkedIn</a>`);
            if (p.languages) badges.push(`<span class="contact-badge">${icons.languages} ${escapeHtml(p.languages)}</span>`);
            document.getElementById('contactBadges').innerHTML = badges.join('');
        }
        
        // Parse date string into comparable numeric value for sorting
        // Handles formats: "2020", "2020-01", "Jan 2020", etc.
        function parseDateForSortLocal(dateStr) {
            if (!dateStr) return 0;
            
            // Format: "YYYY" (year only)
            if (/^\d{4}$/.test(dateStr)) {
                return parseInt(dateStr) * 100;
            }
            
            // Format: "YYYY-MM" (ISO month)
            if (/^\d{4}-\d{2}$/.test(dateStr)) {
                const [year, month] = dateStr.split('-');
                return parseInt(year) * 100 + parseInt(month);
            }
            
            // Format: "Mon YYYY" (e.g., "Jan 2020")
            const monthMatch = dateStr.match(/^([A-Za-z]+)\s+(\d{4})$/);
            if (monthMatch) {
                const months = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];
                const monthIdx = months.indexOf(monthMatch[1].toLowerCase().substring(0, 3));
                const year = parseInt(monthMatch[2]);
                return year * 100 + (monthIdx >= 0 ? monthIdx + 1 : 0);
            }
            
            // Fallback: try to extract year
            const yearMatch = dateStr.match(/(\d{4})/);
            if (yearMatch) {
                return parseInt(yearMatch[1]) * 100;
            }
            
            return 0;
        }
        
        function renderTimelineFromData(experiences) {
            if (!experiences) return;
            const visible = experiences.filter(e => e.visible !== false);
            
            // Sort by start_date ascending (oldest first for timeline - left to right)
            visible.sort((a, b) => {
                const dateA = parseDateForSortLocal(a.start_date);
                const dateB = parseDateForSortLocal(b.start_date);
                return dateA - dateB; // ASC: lower dates first
            });
            
            const container = document.getElementById('timelineItems');
            let lastCountry = null;
            container.innerHTML = visible.map((exp, idx) => {
                const pos = idx % 2 === 0 ? 'top' : 'bottom';
                const countryCode = (exp.country_code || '').toLowerCase();
                const showFlag = countryCode && countryCode !== lastCountry;
                lastCountry = countryCode;
                const marker = showFlag
                    ? `<img src="https://flagcdn.com/w40/${countryCode}.png" class="timeline-flag" alt="${countryCode.toUpperCase()}" onerror="this.outerHTML='<div class=\\'timeline-dot\\'></div>'">`
                    : '<div class="timeline-dot"></div>';
                const period = `${formatDate(exp.start_date)} - ${exp.end_date ? formatDate(exp.end_date) : 'Present'}`;
                return `<div class="timeline-item ${pos}"><div class="timeline-content"><div class="timeline-company">${escapeHtml(exp.company_name)}</div><div class="timeline-role">${escapeHtml(exp.job_title)}</div><div class="timeline-period">${escapeHtml(period)}</div></div>${marker}</div>`;
            }).join('');
        }
        
        function renderExperiencesFromData(experiences) {
            if (!experiences) return;
            const visible = experiences.filter(e => e.visible !== false);
            
            // Sort by start_date descending (newest first)
            visible.sort((a, b) => {
                const dateA = parseDateForSortLocal(a.start_date);
                const dateB = parseDateForSortLocal(b.start_date);
                return dateB - dateA; // DESC: higher dates first
            });
            
            document.getElementById('experienceList').innerHTML = visible.map(exp => `
                <article class="item-card" data-id="${exp.id || ''}" itemscope itemtype="https://schema.org/OrganizationRole">
                    <div class="item-header">
                        <div>
                            <h3 class="item-title" itemprop="roleName">${escapeHtml(exp.job_title)}</h3>
                            <div class="item-subtitle" itemprop="memberOf"><span itemprop="name">${escapeHtml(exp.company_name)}</span></div>
                        </div>
                        <span class="item-date">${formatDate(exp.start_date)} - ${exp.end_date ? formatDate(exp.end_date) : 'Present'}</span>
                    </div>
                    ${exp.location ? `<div class="item-location">${escapeHtml(exp.location)}</div>` : ''}
                    ${exp.highlights && exp.highlights.length ? `<ul class="item-highlights">${exp.highlights.map(h => `<li>${escapeHtml(h)}</li>`).join('')}</ul>` : ''}
                </article>
            `).join('');
        }
        
        function renderCertificationsFromData(certs) {
            if (!certs) return;
            const visible = certs.filter(c => c.visible !== false);
            document.getElementById('certGrid').innerHTML = visible.map(cert => `
                <article class="cert-card" itemscope itemtype="https://schema.org/EducationalOccupationalCredential">
                    <div class="cert-header">
                        <div class="cert-name" itemprop="name">${escapeHtml(cert.name)}</div>
                        <time class="cert-date" itemprop="dateCreated">${escapeHtml(cert.issue_date || '')}</time>
                    </div>
                    <div class="cert-provider" itemprop="issuedBy">${escapeHtml(cert.provider || '')}</div>
                </article>
            `).join('');
        }
        
        function renderEducationFromData(education) {
            if (!education) return;
            const visible = education.filter(e => e.visible !== false);
            document.getElementById('educationList').innerHTML = visible.map(edu => `
                <article class="item-card" itemscope itemtype="https://schema.org/EducationalOccupationalCredential">
                    <div class="item-header">
                        <div>
                            <h3 class="item-title" itemprop="name">${escapeHtml(edu.degree_title)}</h3>
                            <div class="item-subtitle"><span itemprop="name">${escapeHtml(edu.institution_name)}</span></div>
                        </div>
                        <span class="item-date">${escapeHtml(edu.start_date || '')} - ${escapeHtml(edu.end_date || '')}</span>
                    </div>
                    ${edu.description ? `<div class="item-location">${escapeHtml(edu.description)}</div>` : ''}
                </article>
            `).join('');
        }
        
        function renderSkillsFromData(skills) {
            if (!skills) return;
            const visible = skills.filter(s => s.visible !== false);
            document.getElementById('skillsGrid').innerHTML = visible.map(cat => `
                <div class="skill-category">
                    <div class="skill-category-title">
                        <span class="skill-icon">${getSkillIcon(cat.icon, cat.name)}</span>
                        ${escapeHtml(cat.name)}
                    </div>
                    <div class="skill-tags">${cat.skills.map(s => `<span class="skill-tag">${escapeHtml(s)}</span>`).join('')}</div>
                </div>
            `).join('');
        }
        
        function renderProjectsFromData(projects) {
            if (!projects) return;
            const visible = projects.filter(p => p.visible !== false);
            document.getElementById('projectsGrid').innerHTML = visible.map(proj => `
                <article class="project-card" itemscope itemtype="https://schema.org/CreativeWork">
                    <div class="project-header">
                        <h3 class="project-title" itemprop="name">${escapeHtml(proj.title)}</h3>
                        ${proj.link ? `<a href="${escapeHtml(proj.link)}" class="project-link" target="_blank" rel="noopener" title="View Project">${icons.link}</a>` : ''}
                    </div>
                    <p class="project-description" itemprop="description">${escapeHtml(proj.description || '')}</p>
                    <div class="tech-tags">${(proj.technologies || []).map(t => `<span class="tech-tag">${escapeHtml(t)}</span>`).join('')}</div>
                </article>
            `).join('');
        }
        
        // Load print button setting
        async function loadPublicPrintButton() {
            try {
                const result = await api('/api/settings/showPublicPrintButton');
                if (result.value === 'true') {
                    document.getElementById('publicPrintBtn').style.display = 'flex';
                }
            } catch (err) {
                // Ignore errors, button stays hidden
            }
        }
        
        // Load pagination settings for print
        async function loadPaginationSettings() {
            try {
                const enabled = await api('/api/settings/paginationEnabled');
                const position = await api('/api/settings/paginationPosition');
                const style = await api('/api/settings/paginationStyle');
                const profile = await api('/api/profile');
                
                document.body.setAttribute('data-pagination', enabled.value === 'true' ? 'true' : 'false');
                document.body.setAttribute('data-pagination-position', position.value || 'bottom-center');
                document.body.setAttribute('data-pagination-style', style.value || 'simple');
                document.body.setAttribute('data-cv-name', profile.name || 'CV');
                
                // Setup print event handlers
                setupPrintPagination();
            } catch (err) {
                // Ignore errors, pagination stays disabled
            }
        }
        
        // Load page splits settings for print
        async function loadPageSplitsSetting() {
            try {
                const sectionSplits = await api('/api/settings/allowSectionSplits');
                const itemSplits = await api('/api/settings/allowItemSplits');
                
                const sectionEnabled = sectionSplits.value === 'true';
                const itemEnabled = itemSplits.value === 'true';
                
                document.body.classList.toggle('allow-section-splits', sectionEnabled);
                document.body.classList.toggle('allow-item-splits', sectionEnabled && itemEnabled);
            } catch (err) {
                // Default to false (prevent splits)
            }
        }
        
        // Setup print pagination event handlers
        function setupPrintPagination() {
            window.addEventListener('beforeprint', injectPaginationStyles);
            window.addEventListener('afterprint', removePaginationStyles);
        }
        
        // Inject @page CSS rules for pagination
        function injectPaginationStyles() {
            const enabled = document.body.getAttribute('data-pagination') === 'true';
            if (!enabled) return;
            
            const position = document.body.getAttribute('data-pagination-position') || 'bottom-center';
            const style = document.body.getAttribute('data-pagination-style') || 'simple';
            const cvName = document.body.getAttribute('data-cv-name') || 'CV';
            
            // Map position to @page margin box
            const positionMap = {
                'top-left': '@top-left',
                'top-center': '@top-center',
                'top-right': '@top-right',
                'bottom-left': '@bottom-left',
                'bottom-center': '@bottom-center',
                'bottom-right': '@bottom-right'
            };
            const marginBox = positionMap[position] || '@bottom-center';
            
            // Build content based on style
            let content;
            switch (style) {
                case 'with-total':
                    content = 'counter(page) " of " counter(pages)';
                    break;
                case 'with-name':
                    content = `"${cvName.replace(/"/g, '\\"')} | " counter(page)`;
                    break;
                case 'minimal':
                    content = '"— " counter(page) " —"';
                    break;
                case 'simple':
                default:
                    content = 'counter(page)';
                    break;
            }
            
            // Create and inject style element
            const styleEl = document.createElement('style');
            styleEl.id = 'pagination-print-styles';
            styleEl.textContent = `
                @page {
                    ${marginBox} {
                        content: ${content};
                        font-family: 'Inter', sans-serif;
                        font-size: 10pt;
                        color: #666;
                    }
                }
            `;
            document.head.appendChild(styleEl);
        }
        
        // Remove pagination styles after print
        function removePaginationStyles() {
            const styleEl = document.getElementById('pagination-print-styles');
            if (styleEl) {
                styleEl.remove();
            }
        }
        
        // Load and inject tracking code
        async function loadTrackingCode() {
            try {
                const result = await api('/api/settings/trackingCode');
                if (result.value && result.value.trim()) {
                    // Create a container for the tracking code
                    const trackingContainer = document.createElement('div');
                    trackingContainer.id = 'tracking-code-container';
                    trackingContainer.innerHTML = result.value;
                    
                    // Execute any scripts in the tracking code
                    const scripts = trackingContainer.querySelectorAll('script');
                    scripts.forEach(oldScript => {
                        const newScript = document.createElement('script');
                        // Copy attributes
                        Array.from(oldScript.attributes).forEach(attr => {
                            newScript.setAttribute(attr.name, attr.value);
                        });
                        // Copy inline script content
                        newScript.textContent = oldScript.textContent;
                        document.head.appendChild(newScript);
                    });
                    
                    // Append non-script elements to head
                    Array.from(trackingContainer.children).forEach(child => {
                        if (child.tagName !== 'SCRIPT') {
                            document.head.appendChild(child.cloneNode(true));
                        }
                    });
                }
            } catch (err) {
                // Silently fail - tracking is optional
                console.log('Tracking code not loaded:', err.message);
            }
        }
        
        // Load section order from API
        async function loadSectionOrder() {
            try {
                return await api('/api/sections/order');
            } catch (err) {
                console.error('Failed to load section order:', err);
                return [];
            }
        }
        
        // Load custom sections
        async function loadCustomSectionsPublic() {
            try {
                customSectionsData = await api('/api/custom-sections');
                layoutTypesData = await api('/api/layout-types');
                socialPlatformsData = await api('/api/social-platforms');
                
                const container = document.querySelector('.container');
                
                customSectionsData.forEach(section => {
                    const sectionHtml = renderCustomSectionPublic(section, layoutTypesData, socialPlatformsData);
                    container.insertAdjacentHTML('beforeend', sectionHtml);
                });
            } catch (err) {
                console.error('Failed to load custom sections:', err);
            }
        }
        
        // Render sections in correct order in DOM
        function renderSectionsInOrder() {
            if (!sectionOrder.length) return;
            
            const container = document.querySelector('.container');
            if (!container) return;
            
            const header = document.querySelector('.header');
            const atsContent = document.getElementById('ats-content');
            
            // Get all section elements (built-in)
            const sectionElements = {
                'about': document.getElementById('section-about'),
                'timeline': document.getElementById('section-timeline'),
                'experience': document.getElementById('section-experience'),
                'certifications': document.getElementById('section-certifications'),
                'education': document.getElementById('section-education'),
                'skills': document.getElementById('section-skills'),
                'projects': document.getElementById('section-projects')
            };
            
            // Add custom section elements
            customSectionsData.forEach(cs => {
                const el = document.getElementById(`section-${cs.section_key}`);
                if (el) {
                    sectionElements[cs.section_key] = el;
                }
            });
            
            // Reorder sections based on sectionOrder (only visible ones from API)
            let lastInserted = header || atsContent;
            sectionOrder.forEach(section => {
                const el = sectionElements[section.key];
                if (el && lastInserted) {
                    lastInserted.after(el);
                    lastInserted = el;
                    
                    // Apply hidden-print class if section is visible but not print_visible
                    if (section.visible && section.print_visible === false) {
                        el.classList.add('hidden-print');
                    } else {
                        el.classList.remove('hidden-print');
                    }
                }
            });
        }
        
        async function loadThemeColorPublic() {
            try {
                const result = await api('/api/settings/themeColor');
                if (result.value) {
                    applyColorToCSSPublic(result.value);
                }
            } catch (err) {
                // Ignore errors, use default theme
            }
        }
        
        function applyColorToCSSPublic(hex) {
            const root = document.documentElement;
            const hsl = hexToHSLPublic(hex);
            
            root.style.setProperty('--primary', hex);
            root.style.setProperty('--primary-dark', hslToHexPublic(hsl.h, hsl.s, Math.max(hsl.l - 15, 10)));
            root.style.setProperty('--primary-light', hslToHexPublic(hsl.h, Math.min(hsl.s + 10, 100), Math.min(hsl.l + 15, 80)));
            root.style.setProperty('--accent', hslToHexPublic((hsl.h + 15) % 360, hsl.s, hsl.l));
            root.style.setProperty('--dark', hslToHexPublic(hsl.h, hsl.s, 15));
            root.style.setProperty('--light', hslToHexPublic(hsl.h, 30, 90));
            root.style.setProperty('--very-light', hslToHexPublic(hsl.h, 20, 97));
        }
        
        function hexToHSLPublic(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            const r = parseInt(result[1], 16) / 255;
            const g = parseInt(result[2], 16) / 255;
            const b = parseInt(result[3], 16) / 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            if (max === min) { h = s = 0; }
            else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }
            return { h: Math.round(h * 360), s: Math.round(s * 100), l: Math.round(l * 100) };
        }
        
        function hslToHexPublic(h, s, l) {
            s /= 100; l /= 100;
            const a = s * Math.min(l, 1 - l);
            const f = n => {
                const k = (n + h / 30) % 12;
                const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
                return Math.round(255 * color).toString(16).padStart(2, '0');
            };
            return `#${f(0)}${f(8)}${f(4)}`;
        }
    </script>
</body>
</html>
